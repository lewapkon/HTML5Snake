{"ts":1371062473889,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"snake.display = (function() {\n\tvar dom = snake.dom,\n\t\t$ = dom.$,\n\t\tcanvas, ctx,\n\t\tcols, rows,\n\t\tsnakeSize,\n\t\tfirstRun = true,\n\t\tboard,\n\t\tanimations = [],\n\t\ttimer;\n\tfunction createBackground() {\n\t\tvar background = document.createElement(\"canvas\"),\n\t\t\tbgctx = background.getContext(\"2d\");\n\t\tdom.addClass(background, \"background\");\n\t\tbackground.width = cols * snakeSize;\n\t\tbackground.height = rows * snakeSize;\n\t\tbgctx.fillStyle = \"rgba(225,235,255,0.15)\";\n\t\tbgctx.fillRect(0, 0, cols * snakeSize, rows * snakeSize);\n\t\treturn background;\n\t}\n\tfunction addAnimation(runTime, fncs) {\n        var anim = {\n            runTime : runTime,\n            startTime : Date.now(),\n            pos : 0,\n            fncs : fncs\n        };\n        animations.push(anim);\n    }\n\tfunction setup() {\n\t\tvar boardElement = $(\"#game-screen .game-board\")[0];\n\t\tcols = snake.settings.cols;\n\t\trows = snake.settings.rows;\n\t\tsnakeSize = snake.settings.snakeSize;\n\t\t\n\t\tcanvas = document.createElement(\"canvas\");\n\t\tctx = canvas.getContext(\"2d\");\n\t\tdom.addClass(canvas, \"board\");\n\t\tcanvas.width = cols * snakeSize;\n\t\tcanvas.height = rows * snakeSize;\n\t\tctx.scale(snakeSize, snakeSize);\n\t\t\n\t\tboardElement.appendChild(createBackground());\n\t\tboardElement.appendChild(canvas);\n\t\t\n\t\tpreviousCycle = Date.now();\n\t\tcycle();\n\t}\n\tfunction renderAnimations(time, lastTime) {\n        var anims = animations.slice(0), // Kopiuje listę.\n            n = anims.length,\n            animTime,\n            anim,\n            i;\n\n        // Wywołuje funkcję before(). \n        for (i=0;i<n;i++) {\n            anim = anims[i];\n            if (anim.fncs.before) {\n                anim.fncs.before(anim.pos);\n            }\n            anim.lastPos = anim.pos;\n            animTime = (lastTime - anim.startTime);\n            anim.pos = animTime / anim.runTime;\n            anim.pos = Math.max(0, Math.min(1, anim.pos));\n        }\n\n        animations = []; // Resetuje listę animacji.\n\n        for (i=0;i<n;i++) {\n            anim = anims[i];\n            anim.fncs.render(anim.pos, anim.pos - anim.lastPos);\n            if (anim.pos == 1) {\n                if (anim.fncs.done) {\n                    anim.fncs.done();\n                }\n            } else {\n                animations.push(anim);\n            }\n        }\n    }\n\tfunction cycle(time) {\n        renderAnimations(time, previousCycle);\n        previousCycle = time;\n        timer = setTimeout(cycle, 1000/30);\n    }\n\tfunction gameOver(callback) {\n        addAnimation(1000, {\n            render : function(pos) {\n                canvas.style.left =\n                    0.2 * pos * (Math.random() - 0.5) + \"em\";\n                canvas.style.top =\n                    0.2 * pos * (Math.random() - 0.5) + \"em\";\n            },\n            done : function() {\n                canvas.style.left = \"0\";\n                canvas.style.top = \"0\";\n                explode(callback);\n            }\n        });\n    }\n\tfunction explodePieces(pieces, pos, delta) {\n        var piece, i;\n        for (i = 0; i < pieces.length ; i++) {\n            piece = pieces[i];\n\n            piece.vel.y += 50 * delta;\n            piece.pos.y += piece.vel.y * delta;\n            piece.pos.x += piece.vel.x * delta;\n\n            if (piece.pos.x < 0 || piece.pos.x > cols) {\n                piece.pos.x = Math.max(0, piece.pos.x);\n                piece.pos.x = Math.min(cols, piece.pos.x);\n                piece.vel.x *= -1;\n            }\n\n            ctx.save();\n            ctx.globalCompositeOperation = \"lighter\";\n            ctx.translate(piece.pos.x, piece.pos.y);\n            ctx.rotate(piece.rot * pos * Math.PI * 4);\n            ctx.translate(-piece.pos.x, -piece.pos.y);\n            drawObject(piece.type,\n                piece.pos.x - 0.5,\n                piece.pos.y - 0.5,\n                1, piece.rotation\n            );\n            ctx.restore();\n        }\n    }\n\n    function explode(callback) {\n        var pieces = [],\n            piece,\n            x, y,\n            bonus = snake.board.getBonus(),\n            snakes = snake.board.getSnakes();\n        for (i = 0; i < snakes.length; i++) {\n                \tx = snakes[i].X;\n                \ty = snakes[i].Y;\n                \tpiece = {\n                   \t\ttype : board[x][y],\n                    \tpos : {\n                        \tx : x + 0.5,\n                        \ty : y + 0.5\n                    \t},\n                    \tvel : {\n                        \tx : (Math.random() - 0.5) * 20,\n                        \ty : -Math.random() * 10\n                    \t},\n                    \trot : (Math.random() - 0.5) * 3,\n                    \trotation : snakes[i].rot\n                \t}\n                pieces.push(piece);\n        }\n        \n\t\tpieces.push({\n\t\t\ttype : board[bonus.X][bonus.Y],\n\t\t\tpos : {\n\t\t\t\tx : bonus.X,\n\t\t\t\ty : bonus.Y\n\t\t\t},\n\t\t\tvel : {\n\t\t\t\tx : (Math.random() - 0.5) * 20,\n\t\t\t\ty : -Math.random() * 10\n\t\t\t},\n\t\t\trot : (Math.random() - 0.5) * 3,\n\t\t\trotation : 0\n\t\t});\n\t\t\n        addAnimation(3000, {\n            before : function(pos) {\n                ctx.clearRect(0,0,cols,rows);\n            },\n            render : function(pos, delta) {\n                explodePieces(pieces, pos, delta);\n            },\n            done : callback\n        });\n    }\n\tfunction initialize(callback) {\n\t\tif (firstRun) {\n\t\t\tsetup();\n\t\t\tfirstRun = false;\n\t\t}\n\t\tcallback();\n\t}\n\tfunction drawObject(type, x, y, scale, rot) {\n\t\tvar image = snake.images[\"images/images\" + snakeSize + \".png\"];\n\t\tctx.save();\n\t\tif (type == 6) return;\n\t\tif (typeof scale !== \"undefined\" && scale > 0) {\n\t\t\tctx.beginPath();\n\t\t\tctx.rect(x, y, 1, 1);\n\t\t\tctx.clip();\n\t\t\tctx.translate(x + 0.5, y + 0.5);\n\t\t\tctx.scale(scale, scale);\n\t\t\tif (rot) {\n\t\t\t\tctx.rotate(rot);\n\t\t\t}\n\t\t\tctx.translate(-x - 0.5, -y - 0.5);\n\t\t}\n\t\tctx.drawImage(image, type * snakeSize, 0, snakeSize, snakeSize, x, y, 1, 1);\n\t\tctx.restore();\n\t}\n\tfunction redraw(newBoard, snakes) {\n\t\tvar x, y, field;\n\t\tboard = newBoard;\n\t\tctx.clearRect(0, 0, canvas.width, canvas.height);\n\t\tdrawObject(board[snakes[0].X][snakes[0].Y], snakes[0].X, snakes[0].Y, 1, snakes[0].rot * Math.PI / 2);\n\t\tfor (var i = 1; i < snakes.length; i++) {\n\t\t\tx = snakes[i].X;\n\t\t\ty = snakes[i].Y;\n\t\t\tdrawObject(board[x][y], x, y, 1, snakes[i].rot * Math.PI / 2);\n\t\t}\n\t\tfor (x = 0; x < cols; x++) {\n\t\t\tfor (y = 0; y < rows; y++) {\n\t\t\t\tfield = board[x][y];\n\t\t\t\tif (field == 4 || field == 5) {\n\t\t\t\t\tdrawObject(field, x, y, 1, 0);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\treturn {\n\t\tinitialize : initialize,\n\t\tredraw : redraw,\n\t\tgameOver : gameOver\n\t};\n})();\n"]],"start1":0,"start2":0,"length1":0,"length2":6470}]],"length":6470}
{"contributors":[],"silentsave":true,"ts":1371062501264,"patch":[[{"diffs":[[0,"ow();\n\t\t"],[1,"window."],[0,"cycle();"]],"start1":1268,"start2":1268,"length1":16,"length2":23}]],"length":6477,"saved":false}
{"ts":1371062504142,"patch":[[{"diffs":[[0,"\twindow."],[1,"req"],[0,"cycle();"]],"start1":1275,"start2":1275,"length1":16,"length2":19}]],"length":6480,"saved":false}
{"ts":1371062507399,"patch":[[{"diffs":[[0,"ndow.req"],[1,"uestAnimation"],[0,"cycle();"]],"start1":1278,"start2":1278,"length1":16,"length2":29}]],"length":6493,"saved":false}
{"ts":1371062509663,"patch":[[{"diffs":[[0,"nimation"],[1,"Frame("],[0,"cycle();"]],"start1":1291,"start2":1291,"length1":16,"length2":22}]],"length":6499,"saved":false}
{"ts":1371062510293,"patch":[[{"diffs":[[0,"me(cycle"],[-1,"()"],[0,";\n\t}\n\tfu"]],"start1":1302,"start2":1302,"length1":18,"length2":16}]],"length":6497,"saved":false}
{"ts":1371062512457,"patch":[[{"diffs":[[0,"me(cycle"],[1,")"],[0,";\n\t}\n\tfu"]],"start1":1302,"start2":1302,"length1":16,"length2":17}]],"length":6498,"saved":false}
{"ts":1371062525652,"patch":[[{"diffs":[[0,"        "],[1,"//"],[0,"timer = "]],"start1":2397,"start2":2397,"length1":16,"length2":18}]],"length":6500,"saved":false}
{"ts":1371062527411,"patch":[[{"diffs":[[0,"cle = time;\n"],[1,"        window.requestAnimationFrame(cycle);\n"],[0,"        //ti"]],"start1":2385,"start2":2385,"length1":24,"length2":69}]],"length":6545,"saved":false}
